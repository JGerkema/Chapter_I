---
title: "Combine everything"
author: "Jelyn Gerkema"
date: "2023-10-20"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

## 0. Set up
```{r set up}
source("src/settings.R")
source("src/functions.R")

```

## 1. Load data
```{r load data}

load("~/0. PhD/0. Chapter_I/data/processed/aiello1992_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/aiello2011_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/kober_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/buzzard_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/castro_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/chalmandrier_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/choler_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/eallonardo_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/frenette2009_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/frenette2010_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/jaschke_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/kembel_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/liane_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/marteinsdottir_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/raevel_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/riva_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/rolhauser_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/asefa_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/gonzalez_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/standen_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/makelele_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/jager_prep.RData")
load("~/0. PhD/0. Chapter_I/data/processed/osuri_prep.RData")

meta_data <- read_excel("docs/data/Overview_datasets.xlsx")

load("~/0. PhD/0. Chapter I/data/processed/try_traits_tax_final.RData")


trait_imp <- read_csv("data/processed/trait_imp_final311.csv") %>%
  select(-c(`...1`)) %>%
  rename(Name = wfo_match)

classification <- read_delim("data/raw/classification202312.csv", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE)

trait_imp_specieslvl <- trait_imp %>%
  group_by(Name, acceptedNameUsageID, genus, family, order) %>%
  summarise(across(where(is.numeric), ~mean(., na.rm = T))) %>%
  ungroup() %>%
  rename(LA = "Leaf area (in case of compound leaves: leaflet, undefined if petiole is in- or excluded)",
         Bark_thickness = "Bark thickness",
         Leaf_C = "Leaf carbon (C) content per leaf dry mass",
         D13C = "Leaf carbon isotope signature (delta 13C)",
         Leaf_chlor = "Leaf chlorophyll content per leaf dry mass",
         Leaf_N = "Leaf nitrogen (N) content per leaf dry mass",
         Leaf_P = "Leaf phosphorus (P) content per leaf dry mass",
         Leaf_thickness = "Leaf thickness",
         Height = "Plant height vegetative",
         SM = "Seed dry mass",
         PLS = "Plant lifespan (longevity)",
         Leaf_width = "Leaf width",
         SLA = "Leaf area per leaf dry mass (specific leaf area, SLA or 1/LMA): undefined if petiole is in- or excluded",
         Leaf_density = "Leaf density (leaf tissue density, leaf dry mass per leaf volume)",
         Leaf_CN = "Leaf carbon/nitrogen (C/N) ratio",
         LDMC = "Leaf dry mass per leaf fresh mass (leaf dry matter content, LDMC)",
         Litter_N = "Litter nitrogen (N) content per litter dry mass",
         Litter_P = "Litter phosphorus (P) content per litter dry mass",
         Photo_rate = "Photosynthesis rate per leaf area",
         Seed_length = "Seed length",
         WD = "Stem specific density (SSD, stem dry mass per stem fresh volume) or wood density",
         Leaf_resp  = "Leaf respiration rate in the dark per leaf area",
         Root_diam = "Root diameter",
         Root_poros = "Root porosity (fraction of root aerenchyma air space)",
         SRL = "Root length per root dry mass (specific root length, SRL)",
         RDMC  = "Root dry mass per root fresh mass (root dry matter content; RDMC)",
         StDMC =  "Stem dry mass per stem fresh mass (stem dry matter content, StDMC)")

```

```{r extract species names}

data_input_list <-  lst(aiello1992_output, aiello2011_output, buzzard_output, castro_output, chalmandrier_output, choler_output, eallonardo_output, frenette2009_output, frenette2010_output, gonzalez_output, kober_output, jager_output, jaschke_output, asefa_output, kembel_output, liane_output, makelele_output, marteinsdottir_output, osuri_output, raevel_output, riva_output, rolhauser_output, standen_output)


output_species <- data.frame()

for(i in 1:length(data_input_list)){
  
  
  input <- data_input_list[[i]]
  
  species <- input[["input_trait"]] %>% 
  as.data.frame() %>%
  select(Name) %>%
  mutate(study = input[["study_name"]]) %>%
  distinct()
  
  output_species <- bind_rows(output_species, species)
  
  
}

excluded <- output_species %>%
  filter(Name %notin% trait_imp$Name)  %>%
  rename(Orig_name = Name)# 458 unique names

excluded_not_synonyms <- classification %>%
  filter(scientificName %in% excluded$Orig_name) %>%
  select(scientificName, acceptedNameUsageID, taxonomicStatus, nomenclaturalStatus) %>%
  filter(taxonomicStatus != "Synonym")

select_matches <- classification %>%
  filter(scientificName %in% excluded$Orig_name) %>%
  select(scientificName, acceptedNameUsageID, taxonomicStatus, nomenclaturalStatus) %>%
  drop_na(acceptedNameUsageID) %>%
  filter(scientificName %notin% excluded_accepted$scientificName) %>%
  rename(Orig_name = scientificName) %>%
  distinct() %>%
  filter(acceptedNameUsageID %notin% c("wfo-0000845609",
                                       "wfo-0000855460",
                                       "wfo-0001285367",
                                       "wfo-0000871854",
                                       "wfo-0000871222",
                                       "wfo-0000288166",
                                       "wfo-0000199006",
                                       "wfo-0000198960",
                                       "wfo-0000902014",
                                       "wfo-0000881302"))


multiple <- temp %>%
  group_by(Orig_name) %>%
  filter(n() > 1)

new_names_synonyms <- classification %>%
  filter(taxonID %in% select_matches$acceptedNameUsageID) %>%
  select(scientificName, taxonID) %>%
  rename(acceptedNameUsageID = taxonID) %>%
  left_join(select_matches) %>%
  select(-c(nomenclaturalStatus, taxonomicStatus)) %>%
  distinct() %>%
  group_by(Orig_name) %>%
  filter(n() == 1) %>%
  ungroup() %>%
  filter(Orig_name %notin% c("Ehrharta ramosa", "Randia subcordata",
    "Typha glauca", "Eruca sativa", "Fraxinus dubia",
    "Quercus lancifolia", "Saussurea superba", "Smilacina racemosa")) %>% 
  # These new names exists already in their respecitive datasets
  left_join(excluded)


check <- classification %>%
  filter(scientificName %in% excluded$Orig_name) %>%
  select(scientificName, acceptedNameUsageID, taxonomicStatus, nomenclaturalStatus) %>%
  drop_na(acceptedNameUsageID) %>%
  rename(Orig_name = scientificName) %>%
  distinct() # 490

temp <- classification %>%
  filter(taxonID %in% check$acceptedNameUsageID)

included_now <- trait_imp_specieslvl %>%
  filter(acceptedNameUsageID %in% check$acceptedNameUsageID) %>%
  select(Name, acceptedNameUsageID) %>%
  left_join(check) %>%
  distinct() %>%
  filter(acceptedNameUsageID %in% c("wfo-0000845609", "wfo-0000871222",
                                       "wfo-0000871854", "wfo-0000288166")) %>%
  # These synonyms occur twice, based on their nomenclatural status, they are filtered out
 filter(Orig_name %notin% c("Ehrharta ramosa", "Randia subcordata",
    "Typha glauca", "Eruca sativa", "Fraxinus dubia",
    "Quercus lancifolia", "Saussurea superba", "Smilacina racemosa")) %>% 
  # These new names exists already in their respecitive datasets
  select(-c(nomenclaturalStatus)) %>%
  distinct() %>%
  group_by(Orig_name) %>%
  filter(n() == 1) %>%
  ungroup() %>%
  left_join(excluded)


total_species_list <- included_now %>%
  select(c(Name, study)) %>%
  bind_rows(output_species) #1609

length(unique(total_species_list$Name))
length(unique(na_check$wfo_match))

na_check <- try_traits_tax_final %>%
  filter(wfo_match %in% total_species_list$Name) %>%
  select(c(wfo_match, TraitName, StdValue)) %>%
  group_by(wfo_match, TraitName) %>%
  summarize(across(where(is.numeric), ~mean(., na.rm = T))) %>%
  ungroup() %>%
  pivot_wider(values_from = StdValue, names_from = TraitName) 

save <- as.data.frame(rowSums(is.na(na_check)))

na_n_species <- (colSums(is.na(na_check))) %>%
  data.frame() %>%
  rename(na_n = ".") %>%
  mutate(perc_na = na_n/nrow(na_check)) %>%
  rownames_to_column(var = "Trait") %>%
  filter(Trait %notin% c("wfo_match"))

included_species_try <- try_traits_tax_final %>%
  filter(wfo_match %in% total_species_list$Name) %>%
  select(wfo_match) %>%
  distinct()


```

```{r coverages check}

data_summary <- data.frame()

for(i in 1:length(data_input_list)){
  
  dataset <- data_input_list[[i]]
  
  ##
  extract <- included_now %>%
                filter(study == dataset[["study_name"]])
  
  not_included_traits <- c("Leaf_angle", "Photo_path", "Root_density", "Lateral_spread",
                           "Resprout", "Bark_thickness_rel", "Rhizome", "Stem_emerg",
                           "ShootDMC", "Leaf_shape", "Root_diam", "twFWC", "FWC")
  
  traits_orig <- dataset[["trait_information"]][["traitlist"]]

  traits_filtered <- traits_orig[traits_orig %notin% not_included_traits]  
  
  traitlist <- sort(c(traits_filtered))
  cwm_names <- paste0(traitlist, "_cwm")
  cwv_names <- paste0(traitlist, "_cwv")

  trait_information <- lst(traitlist, cwm_names, cwv_names)
  
  if(nrow(extract) > 0){
    
  input_veg <- dataset[["input_veg"]] %>%
   rename(!!!setNames(extract$Orig_name, extract$Name)) %>%
   select(order(colnames(.)))
  
  input_trait <- dataset[["input_trait"]] %>%
    mutate(Name = case_when(
    Name %in% extract$Orig_name ~ extract$Name[match(Name, extract$Orig_name)],
    TRUE ~ Name)) %>%
    arrange(Name)
  }else{
    input_veg <- dataset[["input_veg"]] 
    input_trait <- dataset[["input_trait"]]
  }
  ##
    if(dataset[["trait_detail"]] == "Study"){
  input_trait <- input_trait %>%
    select(Name, all_of(traits_filtered))
  } else{
    input_trait <- input_trait %>%
    select(Name, Plot_code, all_of(traits_filtered))
  }

  input_processed_orig <-  cats_preparation(input_veg = input_veg, 
                                          input_trait = input_trait,
                                          cutoff_value = dataset[["cutoff_value"]],
                                          trait_detail = dataset[["trait_detail"]],
                                          trait_information = trait_information)
  
  n_plot_before_orig <- ncol(input_processed_orig[["relative_abundances"]][["matrix"]])
  
  n_plot_after_orig <- ncol(input_processed_orig[["relative_abundances"]][["matrix4traits_prop"]])
  
    
    regional_trait_coverage_try <- input_processed_orig[["relative_abundances"]][["matrix"]] %>% 
    as.data.frame() %>%
    summarise(across(where(is.numeric), ~ sum(.))) %>%
    t() %>%
    as.data.frame() %>%
    mutate(Total_cover = rowSums(.)) %>%
    select(Total_cover) %>%
    filter(Total_cover != 0) %>%
    mutate(Relative_meta_cover_try = Total_cover / sum(Total_cover)) %>%
    rownames_to_column(var = "Name") %>%
    filter(Name %in% included_species_try$wfo_match) %>%
    select(Name, Relative_meta_cover_try) %>%
    summarise(across(where(is.numeric), ~sum(.))) %>%
    mutate(study = dataset[["study_name"]])
  
  regional_trait_coverage <- input_processed_orig[["relative_abundances"]][["matrix"]] %>% 
    as.data.frame() %>%
    summarise(across(where(is.numeric), ~ sum(.))) %>%
    t() %>%
    as.data.frame() %>%
    mutate(Total_cover = rowSums(.)) %>%
    select(Total_cover) %>%
    filter(Total_cover != 0) %>%
    mutate(Relative_meta_cover_orig = Total_cover / sum(Total_cover)) %>%
    rownames_to_column(var = "Name") %>%
    filter(Name %in% 
             colnames(input_processed_orig[["relative_abundances"]][["matrix_prop_match"]])) %>%
    select(Name, Relative_meta_cover_orig) %>%
    summarise(across(where(is.numeric), ~sum(.))) %>%
    mutate(study = dataset[["study_name"]]) %>%
    full_join(regional_trait_coverage_try) 
  
  input_trait_try <- trait_imp_specieslvl %>% 
         select(c(Name, traits_filtered)) %>%
         filter(Name %in% 
                  colnames(input_processed_orig[["relative_abundances"]][["matrix4traits_prop"]])) 
  
  input_processed_try <- cats_preparation(input_veg = input_veg, 
                                      input_trait = input_trait_try,
                                      trait_information = trait_information, 
                                      cutoff_value = 0.8, 
                                      trait_detail = "Study")
  if(is.null(input_processed_try) == TRUE){
      warning("Relative abundances is empty")
    
    input_processed_try <- cats_preparation(input_veg = input_veg, 
                                      input_trait = input_trait_try,
                                      trait_information = trait_information, 
                                      cutoff_value = 0.6, 
                                      trait_detail = "Study")
    
    n_plot_after_try_06 <- ncol(input_processed_try[["relative_abundances"]][["matrix4traits_prop"]])
 
    plot_count <- bind_cols(n_plot_before_orig = n_plot_before_orig, 
                          n_plot_after_orig =  n_plot_after_orig,
                          n_plot_after_try_08 = 0,
                          n_plot_after_try_06 = n_plot_after_try_06,
                          study = dataset[["study_name"]]) %>%
      full_join(regional_trait_coverage) 

    data_summary <- bind_rows(data_summary, plot_count)
  }

  
  n_plot_after_try_08 <- ncol(input_processed_try[["relative_abundances"]][["matrix4traits_prop"]])
  
  input_processed_try <- cats_preparation(input_veg = input_veg, 
                                      input_trait = input_trait_try,
                                      trait_information = trait_information, 
                                      cutoff_value = 0.6, 
                                      trait_detail = "Study")
  
  n_plot_after_try_06 <- ncol(input_processed_try[["relative_abundances"]][["matrix4traits_prop"]])

  
  plot_count <- bind_cols(n_plot_before_orig = n_plot_before_orig, 
                          n_plot_after_orig =  n_plot_after_orig, 
                          n_plot_after_try_06 = n_plot_after_try_06,
                          n_plot_after_try_08 = n_plot_after_try_08,
                          study = dataset[["study_name"]]) %>%
      full_join(regional_trait_coverage) 

  data_summary <- bind_rows(data_summary, plot_count)
  
  
}

coverage_all <- data.frame()

for(i in 1:length(data_input_list)){
  
  dataset <- data_input_list[[i]]

  veg_data <- list()
  
  veg_data$matrix <- dataset[["input_veg"]]
  
  trait_data <- dataset[["input_trait"]]
  
  # add a matrix of proportional abundances (abundances divided by total site abundances)
  veg_data$matrix_prop <- veg_data$matrix / rowSums(veg_data$matrix)
  
  # add a matrix of proportional abundances that is cut down to species that are matched in trait the data
  veg_data$matrix_prop_match <- veg_data$matrix_prop[, colnames(veg_data$matrix_prop) %in% 
                                trait_data$Name]
  
  veg_data$matrix_prop_match_try <- veg_data$matrix_prop[, colnames(veg_data$matrix_prop) %in% 
                                included_species_try$wfo_match]
  

  coverage <- rowSums(veg_data$matrix_prop_match) %>% 
    as.data.frame() %>%
    rename(coverage_orig = ".") %>%
    rownames_to_column(var = "Plot_code") %>%
    mutate(study = study_lwc[i])

  coverage_per_plot <- rowSums(veg_data$matrix_prop_match_try) %>% 
    as.data.frame() %>%
    rename(coverage_try = ".") %>%
    rownames_to_column(var = "Plot_code") %>%
    mutate(study = study_lwc[i]) %>%
    full_join(coverage)

  coverage_all <- bind_rows(coverage_all, coverage_per_plot)
}

coverage_all_fig <- coverage_all %>%
  relocate(Plot_code, study) %>%
  pivot_longer(cols = 3:4, names_to = "coverage", values_to = "value")

ggplot(coverage_all_fig, aes(x = study, y = value, colour = study)) +
  geom_boxplot() +
  geom_hline(yintercept = 0.8, color = "darkblue", linetype = "dashed", size = 1) +
  geom_hline(yintercept = 0.6, color = "darkblue", linetype = "dashed", size = 1) +
  facet_wrap(~coverage) + 
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r big compilation}


test_function <- function(input_veg, input_veg_fd, input_trait, input_trait_fd, trait_information, 
                         cutoff_value, trait_detail, study_name){
  
  extract <- included_now %>%
                filter(study == study_name)
  
  not_included_traits <- c("Leaf_angle", "Photo_path", "Root_density", "Lateral_spread",
                           "Resprout", "Bark_thickness_rel", "Rhizome", "Stem_emerg",
                           "ShootDMC", "Leaf_shape", "Root_diam", "twFWC", "FWC")
  
  traits_orig <- trait_information[["traitlist"]]

  traits_filtered <- traits_orig[traits_orig %notin% not_included_traits]  
  
  traitlist <- sort(c(traits_filtered))
  cwm_names <- paste0(traitlist, "_cwm")
  cwv_names <- paste0(traitlist, "_cwv")

  trait_information <- lst(traitlist, cwm_names, cwv_names)
  
  if(nrow(extract) > 0){
    
  input_veg <- input_veg %>%
   rename(!!!setNames(extract$Orig_name, extract$Name)) %>%
   select(order(colnames(.)))
  
  input_trait <- input_trait %>%
    mutate(Name = case_when(
    Name %in% extract$Orig_name ~ extract$Name[match(Name, extract$Orig_name)],
    TRUE ~ Name)) %>%
    arrange(Name)
  } 
  
  if(trait_detail == "Study"){
  input_trait <- input_trait %>%
    select(Name, all_of(traits_filtered))
  } else{
    input_trait <- input_trait %>%
    select(Name, Plot_code, all_of(traits_filtered))
  }
  

  input_processed_orig <- cats_preparation(input_veg = input_veg, 
                                      input_trait = input_trait,
                                      trait_information = trait_information, 
                                      cutoff_value = cutoff_value, 
                                      trait_detail = trait_detail)
  
  diversity_info <- calculate_diversity_info(veg_data = input_veg, 
                                             input_veg_fd = input_veg_fd,
                                             input_processed = input_processed_orig, 
                                             trait_fd = input_trait_fd,  
                                             trait_detail = trait_detail, 
                                             study_name = study_name)

    input_trait_try <- trait_imp_specieslvl %>% 
         select(c(Name, traits_filtered)) %>%
         filter(Name %in% 
                  colnames(input_processed_orig[["relative_abundances"]][["matrix4traits_prop"]])) 

  
  input_processed_try <- cats_preparation(input_veg = input_veg, 
                                      input_trait = input_trait_try,
                                      trait_information = trait_information, 
                                      cutoff_value = 0.6, 
                                      trait_detail = "Study")
  
  if(foreach::getDoParRegistered() != TRUE){
    n_cores <- parallel::detectCores() - 5 
    
    my_cluster <- makeSOCKcluster(n_cores)
    
    registerDoSNOW(cl = my_cluster)}   

  
  cats_output_orig <- cats_calculations(input_processed_orig, trait_information, trait_detail) %>%
    mutate(study = study_name)

  cats_output_try <- cats_calculations(input_processed_try, trait_information, trait_detail = "Study") %>%
    mutate(study = study_name)


  all_ouput <- lst(diversity_info, input_processed_orig, input_processed_try, cats_output_orig,  cats_output_try) 
  
  return(all_ouput)
  
    }

output_list_backup <- output_list
output_list <- lst()

data_input_list <-  lst(aiello1992_output, aiello2011_output, buzzard_output, castro_output, chalmandrier_output, choler_output, eallonardo_output, frenette2009_output, frenette2010_output, gonzalez_output, kober_output, jager_output, jaschke_output, asefa_output, kembel_output, liane_output, makelele_output, marteinsdottir_output, osuri_output, raevel_output, riva_output, standen_output, rolhauser_output)

for(i in 1:length(data_input_list)){
  
  dataset <- data_input_list[[i]]

  output <- test_function(input_veg = dataset[["input_veg"]], 
                          input_veg_fd = dataset[["input_veg_fd"]],
                          input_trait = dataset[["input_trait"]],
                          input_trait_fd = dataset[["input_trait_fd"]],
                          cutoff_value = dataset[["cutoff_value"]],
                          trait_detail = dataset[["trait_detail"]],
                          trait_information = dataset[["trait_information"]],
                          study_name = dataset[["study_name"]])

  output_list[[i]] <- output

}



temp_fig <- data.frame()

for(i in 1:length(output_list)){
  
  
  cats_output <- output_list[[i]][["cats_output_orig"]]
  diversity_info <- output_list[[i]][["diversity_info"]]
  
  cats_output_combined_orig <- cats_visualisation(cats_output, "Orig")
  
  cats_output <- output_list[[i]][["cats_output_try"]]
  diversity_info <- output_list[[i]][["diversity_info"]]
  
  cats_output_combined_try <- cats_visualisation(cats_output, "Try")
  
  temp_fig <- bind_rows(temp_fig, cats_output_combined_orig, cats_output_combined_try)
  
  
  
}





```


```{r visualisation}

temp_fig_try <- temp_fig %>%
  filter(traits == "Try") %>%
  select(species_richness, KLR2, Deviance, study, Plot_code) %>%
  rename(KLR2_try = KLR2 )

temp_fig_orig <- temp_fig %>%
  filter(traits == "Orig") %>%
  select(species_richness, KLR2, Deviance, study, Plot_code) %>%
  rename(KLR2_orig = KLR2      ) %>%
  inner_join(temp_fig_try)

ggplot(temp_fig_orig, aes(KLR2_orig, KLR2_try,  colour = study)) +
  geom_point(alpha = 0.3) +
   facet_wrap(~Deviance, scales = "free") + 
  theme_classic() +
  geom_smooth(method = "lm", se = F)  +
    geom_hline(yintercept = 0, linetype = 2) +
   #coord_cartesian(ylim = c(-0.4, 1), ) +
  scale_y_continuous(breaks = c(-0.4, -0.2, 0,0.2, 0.4, 
    0.6,  0.8,  1
  )) + labs(col = "Dataset", shape = "Habitat type")

ggplot(temp_fig_try, aes(x = species_richness, y = KLR2, colour = study)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~Deviance) + 
  theme_classic() +
  geom_smooth(method = "lm", se = F) + 
  labs(title = "The relationship between species richness and the CATS decomposition - TRY values",  
       x = "Local species richness") +
  geom_hline(yintercept = 0, linetype = 2) +
   coord_cartesian(ylim = c(-0.4, 1)) +
  scale_y_continuous(breaks = c(-0.4, -0.2, 0,0.2, 0.4, 
    0.6,  0.8,  1
  )) + labs(col = "Dataset", shape = "Habitat type")

ggplot(test2, aes(x = mean_dist, y = KLR2, colour = study, shape = Habitat_short)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~Deviance) + 
  theme_classic() +
  geom_smooth(method = "lm", se = F) + 
  labs(title = "The relationship between plot dissimilarity and the CATS decomposition",  
       x = "Average Bray-Curtis index value") +
  geom_hline(yintercept = 0, linetype = 2) +
   coord_cartesian(ylim = c(-0.4, 1)) +
  scale_y_continuous(breaks = c(-0.4, -0.2, 0,0.2, 0.4, 
    0.6,  0.8,  1
  )) +
  scale_x_continuous(breaks = c(0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1)) +
  labs(col = "Dataset", shape = "Habitat type")


ggplot(test2, aes(x = log(FRic), y = KLR2, colour = study, shape = Habitat_short)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~Deviance) + 
  theme_classic() +
  geom_smooth(method = "lm", se = F) + 
  labs(title = "The relationship between functional richness and the CATS decomposition",  
       x = "Functional richness (log)") +
  geom_hline(yintercept = 0, linetype = 2) +
   coord_cartesian(ylim = c(-0.4, 1)) +
  scale_y_continuous(breaks = c(-0.4, -0.2, 0,0.2, 0.4, 
    0.6,  0.8,  1
  )) +
  labs(col = "Dataset", shape = "Habitat type")

ggplot(test2, aes(x = FDiv, y = KLR2, colour = study, shape = Habitat_short)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~Deviance) + 
  theme_classic() +
  geom_smooth(method = "lm", se = F) + 
  labs(title = "The relationship between functional richness and the CATS decomposition",  
       x = "Functional richness (log)") +
  geom_hline(yintercept = 0, linetype = 2) +
   coord_cartesian(ylim = c(-0.4, 1)) +
  scale_y_continuous(breaks = c(-0.4, -0.2, 0,0.2, 0.4, 
    0.6,  0.8,  1
  )) +
  labs(col = "Dataset", shape = "Habitat type")

ggplot(test2, aes(x = FEve, y = KLR2, colour = study, shape = Habitat_short)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~Deviance) + 
  theme_classic() +
  geom_smooth(method = "lm", se = F) + 
  labs(title = "The relationship between functional richness and the CATS decomposition",  
       x = "Functional richness (log)") +
  geom_hline(yintercept = 0, linetype = 2) +
   coord_cartesian(ylim = c(-0.4, 1)) +
  scale_y_continuous(breaks = c(-0.4, -0.2, 0,0.2, 0.4, 
    0.6,  0.8,  1
  )) +
  labs(col = "Dataset", shape = "Habitat type")


ggplot(test, aes(x = (species_richness), y = FRic)) +
  geom_point(alpha = 0.12, aes(colour = study)) +
  theme_classic() +
  geom_smooth(method = "lm", se = T)

```



```{r species list}

data_input_list <- lst(aiello1992_processed_specieslvl, aiello2011_processed_specieslvl, bagaria_processed_specieslvl,  buzzard_processed_specieslvl, castro_processed_specieslvl, chalmandrier_processed_specieslvl, choler_processed_specieslvl, eallonardo_processed_specieslvl, frenette2009_processed_specieslvl, frenette2010_processed_specieslvl, gonzalez_processed_specieslvl,
jager_processed_specieslvl, jaschke_processed_specieslvl, kassaw_processed_specieslvl, kembel_processed_specieslvl, liane_processed_specieslvl, makelele_processed_specieslvl, marteinsdottir_processed_specieslvl, osuri_processed_specieslvl, raevel_processed_specieslvl, riva_processed_specieslvl, rolhauser_processed_specieslvl, standen_processed_specieslvl)

output <- data.frame()

for(i in 1:length(data_input_list)){
  
  input <- data_input_list[[i]]
  
  n_plot_before <- ncol(input[["relative_abundances"]][["matrix"]])
  
  n_plot_after <- ncol(input[["relative_abundances"]][["matrix4traits_prop"]])
  
  study <- study_lwc[[i]]
  
  output1 <- bind_cols(n_plot_before = n_plot_before, n_plot_after =  n_plot_after, study = study)
  
  output <- bind_rows(output, output1)
  
}





output_tmp2 <- output %>% 
  #select(-c(study)) %>%
  distinct() %>%
  arrange(Name) %>%
  #pull(Name) %>%
  rename(dataset_name = Name)

total_species_list <- output_tmp2 %>%
  select(dataset_name) %>%
  distinct()

try_tax_final_clean <- try_traits_tax_final %>%
  rename(old_try_name = AccSpeciesName,
         new_wfo_name = new_name)

#These are the species that are present within the new_name list n = 1038
species_present <- total_species_list %>%
  filter(dataset_name %in% c(try_tax_final_clean$new_wfo_name)) %>%
  mutate(new_wfo_name = dataset_name) %>%
  merge(try_tax_final_clean) %>%
  select(new_wfo_name, dataset_name, old_try_name, acceptedNameUsageID) %>%
  distinct()

length(unique(species_present$dataset_name))


# These are the species that are not present in the new_name list
# but do have an entry within the original try species names
species_present2 <- total_species_list %>%
  filter(dataset_name %notin% c(species_present$dataset_name)) %>%
  filter(dataset_name %in% c(try_tax_final_clean$old_try_name)) %>%
  mutate(old_try_name = dataset_name) %>%
  merge(try_tax_final_clean) %>%
  select(new_wfo_name, dataset_name, old_try_name, acceptedNameUsageID) %>%
  distinct()


# In total, 1062 species are present in the filtered try dataset
species_present_both <- bind_rows(species_present, species_present2)

length(unique(species_present_both$dataset_name))

# That means that there are 439 species that are not present, maybe they are present
# under a synonym
not_present <- total_species_list %>%
  filter(dataset_name %notin% c(species_present_both$dataset_name))
  
# Of the species that are not present, 87 have a synonym in the wfo database 
# of species names and in the cleaned try database
not_present_id <- classification %>%
  mutate(scientificName = str_replace_all(scientificName, "  ", " ")) %>%
  filter(scientificName %in% c(not_present$dataset_name)) %>%
  drop_na(acceptedNameUsageID) %>%
  select(acceptedNameUsageID, scientificName) %>%
  rename(dataset_name = scientificName) %>%
  distinct() %>%
  filter(acceptedNameUsageID %in% c(try_tax_final_clean$acceptedNameUsageID)) %>%
  group_by(dataset_name) %>%
  filter(n() == 1) %>%
  ungroup() 

length(unique(id_present$acceptedNameUsageID))

id_present <- not_present_id %>%
  merge(try_tax_final_clean) %>%
  select(new_wfo_name, dataset_name, old_try_name, acceptedNameUsageID) %>%
  distinct()

length(unique(combined_present$dataset_name))

## In total, 1110 species are present in the try database. 
combined_present <- bind_rows(species_present_both, id_present)

combined_present_full <- try_tax_final_clean %>%
  select(genus, family, new_wfo_name, acceptedNameUsageID) %>%
  distinct() %>%
  right_join(combined_present) 

combined_present_tax <- combined_present_full %>%
  select(dataset_name, genus, family) %>%
  distinct()


classification_temp <- classification %>%
   mutate(scientificName = str_replace_all(scientificName, "  ", " ")) %>%
  rename(dataset_name = scientificName)

not_included_final <- total_species_list %>%
  filter(dataset_name %notin% c(combined_present_full$dataset_name)) %>%
  left_join(classification_temp) %>%
  select(genus, family, dataset_name) %>%
  distinct()


final_final <- bind_rows(combined_present_tax, not_included_final) %>%
  left_join(output_tmp2) 



no_data <- final_final %>%
  filter(is.na(genus)) %>%
  separate(dataset_name, into = c("genus"), sep = " ", extra = "drop", remove = F) %>%
  select(-family) 

family_data <- classification %>%
  filter(genus %in% c(no_data$genus)) %>%
  filter(taxonomicStatus != "Synonym") %>%
  select(genus, family) %>%
  distinct() 


 



genus_count <-  table(genus_count$study) %>% as.data.frame() %>%
  rename(study = Var1, genus_n = Freq)
species_count <- table(final_final_final$study) %>% as.data.frame() %>%
  rename(study = Var1, species_n = Freq)
family_count <- table(family_count$study) %>% as.data.frame() %>%
  rename(study = Var1, family_n = Freq)

taxonomic_counts <- lst(genus_count, species_count, family_count) %>%
  reduce(full_join)

coverage_output <- data.frame()



for(i in 1:length(data_input_list)){
  
  input <- data_input_list[[i]]
  
  regional_trait_coverage_try <- input[["relative_abundances"]][["matrix"]] %>% 
    as.data.frame() %>%
    summarise(across(where(is.numeric), ~ sum(.))) %>%
    t() %>%
    as.data.frame() %>%
    mutate(Total_cover = rowSums(.)) %>%
    select(Total_cover) %>%
    filter(Total_cover != 0) %>%
    mutate(Relative_meta_cover_try = Total_cover / sum(Total_cover)) %>%
    rownames_to_column(var = "Name") %>%
    filter(Name %in% combined_present_tax$dataset_name) %>%
    select(Name, Relative_meta_cover_try) %>%
    summarise(across(where(is.numeric), ~sum(.))) %>%
    mutate(study = study_lwc[i])
  
  regional_trait_coverage <- input[["relative_abundances"]][["matrix"]] %>% 
    as.data.frame() %>%
    summarise(across(where(is.numeric), ~ sum(.))) %>%
    t() %>%
    as.data.frame() %>%
    mutate(Total_cover = rowSums(.)) %>%
    select(Total_cover) %>%
    filter(Total_cover != 0) %>%
    mutate(Relative_meta_cover_orig = Total_cover / sum(Total_cover)) %>%
    rownames_to_column(var = "Name") %>%
    filter(Name %in% colnames(input[["relative_abundances"]][["matrix_prop_match"]])) %>%
    select(Name, Relative_meta_cover_orig) %>%
    summarise(across(where(is.numeric), ~sum(.))) %>%
    mutate(study = study_lwc[i]) %>%
    full_join(regional_trait_coverage_try)
  
  coverage_output <- bind_rows(coverage_output, regional_trait_coverage)
  
  
}

genus_prep <-   kassaw_processed_specieslvl[["relative_abundances"]][["matrix"]] %>% 
    as.data.frame() %>% 
    rownames_to_column(var = "Plot_code") %>%
    pivot_longer(cols = 2:ncol(.), values_to = "abund", names_to = "dataset_name") 

genus_lvl_test <- final_final_final %>%
  filter(study == "kassaw") %>%
  full_join(genus_prep) %>%
  select(-c(dataset_name, family, study)) %>%
  group_by(genus, Plot_code) %>%
  summarize(across(where(is.numeric), ~sum(abund))) %>%
  ungroup() %>%
  pivot_wider(values_from = "abund", names_from = "genus") %>%
  column_to_rownames(var = "Plot_code")



coverage_output_tmp <- coverage_output %>%
  relocate(Relative_meta_cover_orig, Relative_meta_cover_try, study) %>%
  mutate(check = case_when(Relative_meta_cover_try >= 0.8 ~ "Yes",
                           Relative_meta_cover_try <0.8 ~ "No"))



``` 

### impact of bias
```{r cats bias}

colnames(aiello1992_cats)

cats_list <- lst(aiello1992_cats, aiello2011_cats, bagaria_cats, bergholz_cats, buzzard_cats, castro_cats, chalmandrier_cats, choler_cats, eallonardo_cats, frenette2009_cats, frenette2010_cats, gonzalez_cats, jaschke_cats, kassaw_cats, kembel_cats, liane_cats, makelele_cats, marteinsdottir_cats, raevel_cats, riva_cats, rolhauser_cats, standen_cats)

figure_list <- lst(aiello1992_figure, aiello2011_figure, bagaria_figure, bergholz_figure, buzzard_figure, castro_figure, chalmandrier_figure, choler_figure, eallonardo_figure, frenette2009_figure, frenette2010_figure, gonzalez_figure, jaschke_figure, kassaw_figure, kembel_figure, liane_figure, makelele_figure, marteinsdottir_figure, raevel_figure, riva_figure, rolhauser_figure, standen_figure)

output <- data.frame()

for(i in 1:length(cats_list)){
  
  
  input_cats <- cats_list[[i]]
  input_figure <- figure_list[[i]]
  
  cats <- input_cats %>% 
  select(`model.bias`, `model.uniform.prior.plus.traits`, `model.mean.null.given.uniform`,
         `model.mean.null.given.prior`, `model.prior.plus.traits`, `Plot_code`, `study`)
  
  diversity <- input_figure %>%
  select(species_richness, shannon, simpson, empty_states, meta_size, mean_dist, study, Plot_code) %>%
  distinct() %>%
  full_join(cats)
  
  output <- bind_rows(output, diversity)
  
  
}

output2 <- output %>%
  pivot_longer(cols = 9:12, values_to = "Value", names_to = "Model")

output3 <- output %>%
  mutate(just.neutral1 = model.prior.plus.traits - model.uniform.prior.plus.traits,
      just.neutral2 = model.mean.null.given.prior - model.mean.null.given.uniform,
      just.traits1 = model.uniform.prior.plus.traits - model.mean.null.given.uniform,
      just.traits2 = model.prior.plus.traits - model.mean.null.given.prior,
      information.unique.to.local.trait.constraints = just.traits2 ,
      information.unique.to.neutral.prior = just.neutral1 ,
      delta.R.trait = just.traits1,
      delta.R.neutral = just.neutral2,
      T1 = just.traits1 - just.traits2,
      T2 = just.neutral2 - just.neutral1,
      joint.information = T2 ,
      biologically.unexplained.information = (1 - model.prior.plus.traits)) %>%
  select(-c(T1, T2, just.neutral1, just.neutral2, just.traits1, just.traits2,
            delta.R.trait, delta.R.neutral)) %>%
  pivot_longer(cols = 14:17, values_to = "KLR2", names_to = "Deviance") %>%
  mutate(Deviance = recode(Deviance,
                             biologically.unexplained.information = "Unexplained effect",
                             information.unique.to.neutral.prior = "Pure metacommunity effect",
                             joint.information = "Joint trait & metacommunity effect",
                             information.unique.to.local.trait.constraints = "Pure trait effect"
    ))



ggplot(output3, aes(x =  `species_richness`, y = KLR2, colour = study)) +
  geom_point(alpha = 0.3) +
  theme_classic() +
  geom_smooth(method = "lm", se = F) + 
  labs(title = "CATS decomposition, uncorrected for bias",
       x = "Species richness") +
  labs(col = "Dataset") + facet_wrap(~Deviance) +
    geom_hline(yintercept = 0, linetype = 2) 

output4 <- full_join(output, meta_data)

ggplot(output4, aes(x = `species_richness`, y = `model.bias`, colour = study,
                   shape = Habitat_short)) + 
  geom_point(alpha = 0.3) +
  theme_classic() +
  geom_smooth(method = "lm", se = F) +
  labs(title = "Relationship between model bias and species richness (distribution length)",
       x = "Species richness", y = "Model bias", col = "Dataset", shape = "Habitat type") 

ggplot(output2, aes(x =  `empty_states`, y = Value, colour = study)) +
  geom_point(alpha = 0.3) +
  theme_classic() +
  geom_smooth(method = "lm", se = F) + 
  labs(title = "  ") +
  labs(col = "Dataset") + facet_wrap(~Model)
```



```{r figures}
assigned_colnames <- paste0("species_", letters[1:20])

community_a <- c(rep(0.125, 8), rep(NA, 20-8)) %>% t() %>% as.data.frame()
colnames(community_a) <- assigned_colnames

community_b <- c(rep((1/10), 10), rep(NA, 20-10)) %>% t() %>% as.data.frame()
colnames(community_b) <- assigned_colnames

community_c <- c(rep((1/4), 4), rep(NA, 20-4)) %>% t() %>% as.data.frame()
colnames(community_c) <- assigned_colnames

community_d <- c(rep((1/12), 12), rep(NA, 20-12)) %>% t() %>% as.data.frame()
colnames(community_d) <- assigned_colnames

community_e <- rep((1/20), 20) %>% t() %>% as.data.frame()
colnames(community_e) <- assigned_colnames


community_df <- bind_rows(community_c, community_a, community_b,
                          community_d, community_e) %>%
  rownames_to_column(var = "Community") %>%
  pivot_longer(cols = 2:ncol(.), values_to = "Probability", names_to = "Species") %>%
  mutate(Species = as.character(Species) %>% fct_reorder(Species))


ggplot(community_df, aes(x = Species, y = Probability, colour = Community, group = Community)) +
  geom_point() + geom_line() + theme_classic() +
  theme(axis.text.x = element_text(angle = 70, vjust = 0.5)) +
  labs(title = "Uniform species probability distributions (1/S)") +
   coord_cartesian(ylim = c(0, 0.3))


random_numbers <- runif(20)


probability_distribution <- random_numbers / sum(random_numbers)

community_f <- probability_distribution %>% t() %>% as.data.frame()

community_g <-  probability_distribution %>% t() %>% as.data.frame()

community_h <-  c(0.2, 0.15, 0.1, 0.07, 0.06, 0.03, rep((0.39/14), 14))  %>% t() %>% 
as.data.frame()
colnames(community_f) <- assigned_colnames
colnames(community_g) <- assigned_colnames
colnames(community_h) <- assigned_colnames


random_numbers <- abs(rnorm(20))

probability_distribution <- random_numbers / sum(random_numbers)

community_i <-  probability_distribution %>% t() %>% as.data.frame()
community_j <-  c(rep((0.23/12), 12),
                 0.02, 0.02, 0.03, 0.03, 
                 0.07, 0.1, 0.2, 0.3) %>% t() %>% as.data.frame()

colnames(community_i) <- assigned_colnames
colnames(community_j) <- assigned_colnames




community_random <- bind_rows(community_i) %>%
  rownames_to_column(var = "Community") %>%
  pivot_longer(cols = 2:ncol(.), values_to = "Probability", names_to = "Species") %>%
  mutate(Species = as.character(Species) %>% fct_reorder(Species))


ggplot(community_random, aes(x = Species, y = Probability, colour = Community, group = Community)) +
  geom_point() + geom_line() + theme_classic() +
  theme(axis.text.x = element_text(angle = 70, vjust = 0.5)) +
  labs(title = "Random species probability distributions", x = NULL) +
   coord_cartesian(ylim = c(0, 0.3))


community_o <-  c(0.3, 0.2, 0.1, 0.07, 0.06, 0.02, 0.02, rep((0.23/13), 13)) %>% 
  t() %>% as.data.frame()

community_p <- c(0.2, 0.1, 0.1, 0.03, 0.03, 0.1, 0.1, rep((0.66/13), 13)) %>% 
  t() %>% as.data.frame()

community_r <- c(0.34, 0.28, 0.11, 0.05, 0.05, 0.03, rep((0.14/13), 14)) %>% 
  t() %>% as.data.frame()

colnames(community_o) <- assigned_colnames
colnames(community_p) <- assigned_colnames
colnames(community_r) <- assigned_colnames

community_exam <- bind_rows(community_o) %>%
  rownames_to_column(var = "Community") %>%
  pivot_longer(cols = 2:ncol(.), values_to = "Probability", names_to = "Species") %>%
  mutate(Species = as.character(Species) %>% fct_reorder(Species))


ggplot(community_exam, aes(x = Species, y = Probability, colour = Community, group = Community)) +
  geom_point() + geom_line() + theme_classic() +
  theme(axis.text.x = element_text(angle = 70, vjust = 0.5)) +
  labs(title = "Random species probability distributions", x = NULL, colour = NULL) +
   coord_cartesian(ylim = c(0, 0.3))


```