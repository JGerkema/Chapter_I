---
title: "CATS function complete"
author: "Jelyn Gerkema"
date: "2023-05-01"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 0. Set up 
```{r set up}
source("src/settings.R")
source("src/functions.R")
source("src/trait_information.R")


temp <- Data_for_Dryad_2.27.16$species_data %>% filter(site == "CAM1")

temp2 <- Data_for_Dryad_2.27.16$site_data
```


## 1. Load data 
```{r load data}
                                                         
grassland_2008_2020 <- read_csv("data/raw/Grassland_2008-2020.csv") %>% 
                      select(-c(PlotID)) %>% rename(PlotID = EP_PlotID)

species_traits <- read_delim("data/raw/Species_traits.txt", 
                  delim = "\t", escape_double = FALSE, 
                  trim_ws = TRUE, show_col_types = FALSE)

species_taxon <- read_delim("data/raw/Species_taxon.txt", 
  delim = "\t", escape_double = FALSE, 
  trim_ws = TRUE) %>% dplyr::select("Species", "Genus", "Family") %>%
  mutate(Family = recode(Family, `Campanulaceae\xa0` = "Campanulaceae",
                         `Convolvulaceae\xa0` = "Convolvulaceae"
                         ))

plotdata_landtype <- read_delim("data/raw/Plotdata_landtype.csv",
                                delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% 
                                rename(PlotID = `Plot ID`) %>%
                                mutate(`Land use type` = recode(`Land use type`, `Mown Pasture` = "Mown pasture")) 

plotdata_coor <- read_csv("data/raw/1000_7_data.csv") %>% 
                 rename(PlotID = EP_Plot_ID) %>%
                 mutate(Exploratory = recode(Exploratory, ALB = "Schwäbische Alb",
                                             SCH = "Schorfheide-Chorin",
                                             HAI = "Hainich-Dün"))

``` 

## 2. Clean and merge data 
```{r combine and calculate}

grassland_2008_2020_clean <- 	grassland_2008_2020 %>% 
                              mutate(Species = recode(Species, Achillea_millefolium_aggr. = "Achillea_millefolium",
                                                      Alchemilla_vulgaris_aggr. = "Alchemilla_vulgaris",
                                                      Bromus_hordeaceus_aggr.incl_B_commutatus = "Bromus_hordeaceus",
                                                      Carex_muricata_aggr. = "Carex_muricata",
                                                      Cerastium_pumilum_aggr. = "Cerastium_pumilum",
                                                      Capsella_bursa_pastoris = "Capsella_bursa-pastoris",
                                                      Carex_ovalis = "Carex_leporina",
                                                      Festuca_ovina_aggr. = "Festuca_ovina",
                                                      Festuca_rubra_aggr. = "Festuca_rubra",
                                                      Leucanthemum_vulgare_aggr. = "Leucanthemum_vulgare",
                                                      Matricaria_recutita = "Matricaria_chamomilla",
                                                      Ononis_repens_spinosa_aggr. = "Ononis_spinosa",
                                                      Phleum_pratense_aggr. = "Phleum_pratense",
                                                      Poa_pratensis_aggr. = "Poa_pratensis",
                                                      Silene_flos_cuculi = "Silene_flos-cuculi",
                                                      Betonica_officinalis = "Stachys_officinalis",
                                                      Vicia_sativa_aggr. = "Vicia_sativa",
                                                      Vicia_tetrasperma_aggr. = "Vicia_tetrasperma"))
  

species_traits_clean <- species_traits %>% 
                        dplyr::select("Species", "Seed.weight", "LEDA_SLA_est", "LEDA_Height_est",
                               "D_Maximum.rooting.depth_est", "M_Specific.root.length_est",
                             "M_Root.weight.ratio_est", "Mycostat_FungalRoot", "M_Root.tissue.density.Rose_est") %>%
                        mutate(Mycostat_FungalRoot = recode(Mycostat_FungalRoot,
                                                            OM = 3,
                                                            `NM-AM` = 2,
                                                            NM = 1))


# The original article states that 239 of the 241 species they have trait data for, are present in the Biodiversity Exploratories EP plots. This, however, does not seem to be the case... for some, no match is found, even after the corrections in species names above.   

plot_metadata <- inner_join(plotdata_landtype, plotdata_coor) 

```


## 3. Prepare input for data_analysis at different taxonomic level: family, genus and species
```{r prepare data}
# The species data should be put in a matrix, where each column represents a species and each row a plot, with the plotIDS in the rownames.
traits_specieslvl <- species_traits_clean %>% rename(Name = Species)

traits_genuslvl <- species_traits_clean %>%
  separate(Species, into = c("Genus", "Species"), sep = "_") %>%
  select(-Species) %>%
  group_by(Genus) %>%
  summarize(across(where(is.numeric), mean)) %>%
  rename(Name = Genus)

traits_familylvl <- species_traits_clean %>%
  inner_join(species_taxon) %>%
  select(-c(Species, Genus)) %>%
  group_by(Family) %>%
  summarize(across(where(is.numeric), mean)) %>%
  rename(Name = Family)

veg_specieslvl <- grassland_2008_2020_clean %>%
  mutate(Plot_code = paste(Year, PlotID)) %>% 
  select(-c(Useful_EP_PlotID, Year, PlotID, PlotID)) %>%
  drop_na() %>% 
  arrange(Species) %>%
  pivot_wider(names_from = Species, values_from = Cover) %>%
  column_to_rownames(var = "Plot_code") %>% as.matrix()

veg_genuslvl <- grassland_2008_2020_clean %>%
  mutate(Plot_code = paste(Year, PlotID)) %>%
  drop_na() %>%
  separate(Species, into = c("Genus", "Species"), sep = "_", extra = "merge") %>%
  select(-c(Useful_EP_PlotID, Year, PlotID, Species)) %>%
  arrange(Genus) %>%
  group_by(Plot_code, Genus) %>%
  summarize(Genus_cover = sum(Cover)) %>%
  ungroup() %>%
  pivot_wider(names_from = Genus, values_from = Genus_cover) %>%
  column_to_rownames(var = "Plot_code") %>%
  as.matrix()

veg_familylvl <- grassland_2008_2020_clean %>%
  inner_join(species_taxon) %>%
  mutate(Plot_code = paste(Year, PlotID)) %>%
  drop_na() %>%
  select(-c(Useful_EP_PlotID, Year, PlotID, Species, Genus)) %>%
  arrange(Family) %>%
  group_by(Plot_code, Family) %>%
  summarize(Family_cover = sum(Cover)) %>%
  ungroup() %>%
  pivot_wider(names_from = Family, values_from = Family_cover) %>%
  column_to_rownames(var = "Plot_code") %>%
  as.matrix()


```

## 4. Calculate the relative species abundances and filter dataset
```{r relative abundances}

processed_specieslvl <- calculate_multiple_cwm_cwv(veg_specieslvl, traits_specieslvl)
processed_genuslvl <- calculate_multiple_cwm_cwv(veg_genuslvl, traits_genuslvl)
processed_familylvl <- calculate_multiple_cwm_cwv(veg_familylvl, traits_familylvl)

```

## 5. Calculate plot richness on different taxonomic levels
The filtered dataset is used to calculate species, genus and family richness of each plot. Note; the filtered dataset only contains species for which trait data was available, meaning that the true richness will be sligthly higher. 

```{r caculate tax rich}

veg_clean <- processed_specieslvl[["relative_abundances"]][["matrix4traits_prop"]] %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "Plot_code") %>%
  pivot_longer(cols = 2:ncol(.), names_to = "Species", values_to = "Relative_cover")

species_richness <- veg_clean %>% 
  filter(Relative_cover != 0) %>%
  mutate(Presence = 1) %>% 
  group_by(Plot_code) %>% 
  count(Presence, name = "Species_richness") %>% 
  select(-c("Presence"))

species_genus <- veg_clean %>% 
  filter(Relative_cover != 0) %>% 
  left_join(species_taxon, by = "Species") %>% 
  group_by(Plot_code) %>%
  count(Genus, name = "Genus_richness") 

species_family <- veg_clean %>% 
  filter(Relative_cover != 0) %>% 
  left_join(species_taxon, by = "Species") %>% 
  group_by(Plot_code) %>%
  count(Family, name = "Family_richness") 

taxonomic_richness <- list(species_richness, species_genus, species_family) %>% 
                  reduce(inner_join, by = "Plot_code")
```



## 4. Save new datafiles
```{r save data}

save(processed_specieslvl, processed_genuslvl, processed_familylvl, 
  taxonomic_richness, plot_metadata, file = "data/processed/Bio_exp_processed.RData")

```
